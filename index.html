<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AwesomeVoice v0.3</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; flex-direction: column; height: 100vh; background: #2196F3; color: white; overflow: hidden; }
        #app-info { position: fixed; top: 10px; right: 10px; color: rgba(255,255,255,0.4); font-size: 12px; cursor: pointer; user-select: none; z-index: 100; }
        #display { flex: 1; padding: 20px; font-size: 2rem; overflow-y: auto; display: flex; align-items: center; justify-content: center; text-align: center; }
        #control-area { height: 40vh; display: flex; flex-direction: column; border-top: 4px solid white; }
        .full-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; cursor: pointer; text-align: center; padding: 10px; }
        #confirm-row { flex: 1; display: none; }
        .half-btn { flex: 1; display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold; cursor: pointer; border-right: 2px solid white; }
        #mic-btn { background: #f44336; }
        #send-btn { background: #4CAF50; }
        #retry-btn { background: #757575; border-right: none; }
        .loading { background: #9e9e9e !important; cursor: wait; }
        #settings-modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; padding: 30px; box-sizing: border-box; overflow-y: auto; }
        #settings-modal input { width: 100%; font-size: 1.3rem; margin: 5px 0 15px; padding: 10px; box-sizing: border-box; }
        #settings-modal button { width: 100%; padding: 15px; font-size: 1.3rem; font-weight: bold; cursor: pointer; margin-bottom: 10px; border-radius: 5px; border:none; }
    </style>
</head>
<body>
    <div id="app-info">AwesomeVoice v0.3</div>
    <div id="display">画面を叩いてお話しください</div>
    <div id="control-area">
        <div id="mic-btn" class="full-btn">録音する</div>
        <div id="confirm-row" class="full-btn">
            <div id="send-btn" class="half-btn">送信</div>
            <div id="retry-btn" class="half-btn">やり直し</div>
        </div>
    </div>

    <div id="settings-modal">
        <h2>設定</h2>
        <label>送信元の名前</label><input type="text" id="from-name">
        <label>送信元メール</label><input type="email" id="from-email">
        <label>送信先の名前</label><input type="text" id="to-name">
        <label>送信先メール</label><input type="email" id="to-email">
        <label>文体</label>
        <div style="margin: 15px 0;">
            <label><input type="radio" name="context" value="家族へ" checked> 家族</label>
            <label><input type="radio" name="context" value="友人へ"> 友人</label>
            <label><input type="radio" name="context" value="仕事で"> 仕事</label>
        </div>
        <button onclick="saveSettings()" style="background: #4CAF50; color: white;">保存して閉じる</button>
        <button onclick="closeSettings()" style="background: #757575; color: white;">キャンセル</button>
    </div>

    <script>
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyxWyf2nIevja18gS9W7u-PYONHWuqR8zqtf1FYSE-_9BmV6DqjP6V2keJOQ9wuhs4LoQ/exec";
        const MAX_TIME = 45; const SILENCE_TIME = 5; const SILENCE_THRESHOLD = 0.01;
        let mediaRecorder, audioChunks = [], lastAnalysis = null, audioContext, analyser, dataArray, silenceTimer, recordingTimer;
        const micBtn = document.getElementById('mic-btn'), confirmRow = document.getElementById('confirm-row'), display = document.getElementById('display');

        document.getElementById('app-info').onclick = () => { openSettings(); };
        function openSettings() {
            const saved = localStorage.getItem('awesome_voice_config');
            if (saved) {
                const c = JSON.parse(saved);
                document.getElementById('from-name').value = c.fromName || "";
                document.getElementById('from-email').value = c.fromEmail || "";
                document.getElementById('to-email').value = c.toEmail || "";
                document.getElementById('to-name').value = c.toName || "";
            }
            document.getElementById('settings-modal').style.display = 'block';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function saveSettings() {
            const config = {
                fromName: document.getElementById('from-name').value,
                fromEmail: document.getElementById('from-email').value,
                toEmail: document.getElementById('to-email').value,
                toName: document.getElementById('to-name').value,
                context: document.querySelector('input[name="context"]:checked').value
            };
            localStorage.setItem('awesome_voice_config', JSON.stringify(config));
            closeSettings();
        }

        micBtn.onclick = () => {
            if (!mediaRecorder || mediaRecorder.state === "inactive") startRecording();
            else stopRecording();
        };

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            audioContext = new AudioContext();
            const source = audioContext.createMediaStreamSource(stream);
            analyser = audioContext.createAnalyser();
            source.connect(analyser);
            dataArray = new Float32Array(analyser.fftSize);
            
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = handleRecordingStop;
            mediaRecorder.start();

            let timeLeft = MAX_TIME;
            recordingTimer = setInterval(() => { timeLeft--; if (timeLeft <= 0) stopRecording(); }, 1000);
            detectSilence();
            micBtn.style.background = "#ffeb3b"; micBtn.innerText = "終わったら叩く";
        }

        function detectSilence() {
            if (!mediaRecorder || mediaRecorder.state !== "recording") return;
            analyser.getFloatTimeDomainData(dataArray);
            let peak = 0;
            for (let i = 0; i < dataArray.length; i++) if (Math.abs(dataArray[i]) > peak) peak = Math.abs(dataArray[i]);
            if (peak < SILENCE_THRESHOLD) { if (!silenceTimer) silenceTimer = setTimeout(() => stopRecording(), SILENCE_TIME * 1000); }
            else { clearTimeout(silenceTimer); silenceTimer = null; }
            requestAnimationFrame(detectSilence);
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                clearInterval(recordingTimer);
                clearTimeout(silenceTimer);
                micBtn.innerText = "解析中...";
                micBtn.classList.add('loading');
            }
        }

        async function handleRecordingStop() {
            const blob = new Blob(audioChunks, { type: 'audio/webm' });
            const base64 = await new Promise(r => { const reader = new FileReader(); reader.onloadend = () => r(reader.result.split(',')[1]); reader.readAsDataURL(blob); });
            const config = JSON.parse(localStorage.getItem('awesome_voice_config') || "{}");
            try {
                const res = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "analyze", audio: base64, context: config.context || "家族へ" }) });
                const json = await res.json();
                if (json.status === "success") {
                    lastAnalysis = json.analysis;
                    lastAnalysis.row = json.row;
                    display.innerText = lastAnalysis.inference;
                    micBtn.style.display = "none"; confirmRow.style.display = "flex";
                } else { throw new Error(json.message); }
            } catch (err) { display.innerText = "エラー: " + err.message; setTimeout(resetUI, 3000); }
        }

        document.getElementById('send-btn').onclick = async () => {
            const config = JSON.parse(localStorage.getItem('awesome_voice_config') || "{}");
            display.innerText = "送信中..."; confirmRow.style.display = "none";
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "send", analysis: lastAnalysis, row: lastAnalysis.row, settings: config, accepted: 1 }) });
            alert("送信完了"); resetUI();
        };

        document.getElementById('retry-btn').onclick = async () => {
            const config = JSON.parse(localStorage.getItem('awesome_voice_config') || "{}");
            confirmRow.style.display = "none";
            await fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: "log_only", analysis: lastAnalysis, row: lastAnalysis.row, settings: config, accepted: 0 }) });
            resetUI();
        };

        function resetUI() {
            micBtn.style.display = "flex"; confirmRow.style.display = "none";
            micBtn.innerText = "録音する"; micBtn.style.background = "#f44336";
            micBtn.classList.remove('loading'); display.innerText = "画面を叩いてお話しください";
            if (mediaRecorder && mediaRecorder.stream) { mediaRecorder.stream.getTracks().forEach(t => t.stop()); }
            if (audioContext) audioContext.close().catch(()=>{});
            mediaRecorder = null; audioChunks = []; lastAnalysis = null;
        }
    </script>
</body>
</html>
